<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

</head>
<body>
<div class="alert alert-dark" role="alert" style="background-color: #343a40; margin-bottom: auto; border: none">
    <p style="color: white;font-weight:300;display: inline; font-style: oblique" th:text="${thisUser.getEmail()}">
    <p style="color: white;display: inline" id="withRoles"> with roles:
    <p style="color: white; display: inline; font-style: oblique" th:each="role : ${thisUser.getRoles()}" th:text="${role.getAuthority()}"/>
    <a style="color: #6e7275; margin-left: 870px; position: fixed; text-align: right;display: inline" href="logout">Logout</a>

</div>
<nav class="nav flex-column" style="width: 150px; float: left; margin-top: 10px" >
    <a style="width: 100%" class="nav-link active" href="/user">User</a>
    <a style="width: 100%" class="nav-link" href="/admin">Admin</a>
</nav>
<div id="tableContainer" class="container" style="width: 1199px; height: 600px; float: right; background-color: #f8f9fa">
    <h1>Admin Panel</h1>
    <div style="height: 40px; width: 200px">
    <div style="float: left; vertical-align:middle; display:table-cell; height: 100%; width: 50%; background-color: white; border-block-width: 1px; border-radius: 3px;border-color: #ebebeb; border-style: solid">
        <p style="text-align: center; padding-top: 5px">Users Table</p>
    </div>
    <div style="float: right; vertical-align:middle; display:table-cell; height: 100%; width: 50%">
        <p style="cursor: pointer;color: blue; text-align: center; padding-top: 5px;"><a id="toUser">New User</a> </p>
    </div>
    </div>
    <div style="width: 900px; vertical-align:middle; display:table-cell;background-color: #f7f7f7; border-color: #ebebeb;height: 45px; border-block-width: 1px; border-style: solid; border-radius: 3px"><h5 style="vertical-align: center; padding-top: 5px; left: 10px; padding-left: 20px">All Users</h5></div>
<table id="table" class="table" style="background-color: white; width: 900px; border-block-width: 1px;border-color: #ebebeb; border-style: solid; border-radius: 3px ">
    <thead>
    <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Surname</th>
        <th>Age</th>
        <th>Email</th>
        <th>Role</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
    </thead>
    <tbody class=".table-hover" id = "userTable">

    </tbody>
</table>
</div>

<div id="newUserContainer" class="container" style="display:none; width: 1199px; height: 600px; float: right; background-color: #f8f9fa">
    <h1>Admin Panel</h1>
    <div style="height: 40px; width: 200px">
        <div style="float: left; vertical-align:middle; display:table-cell; height: 100%; width: 50%">
            <p style="cursor: pointer; color: blue; text-align: center; padding-top: 5px;"><a id="toTable">Users Table</a></p>
        </div>
        <div style="float: right; vertical-align:middle; display:table-cell; height: 100%; width: 50%; background-color: white; border-block-width: 1px; border-radius: 3px;border-color: #ebebeb; border-style: solid">
            <p style="text-align: center; padding-top: 5px">New User </p>
        </div>
    </div>
    <div style="width: 900px; vertical-align:middle; display:table-cell;background-color: #f7f7f7; border-color: #ebebeb;height: 45px; border-block-width: 1px; border-style: solid; border-radius: 3px"><h5 style="vertical-align: center; padding-top: 5px; left: 10px; padding-left: 20px">All Users</h5></div>
    <form name="addUserForm" id="newUserForm">
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label for="name">Enter name</label><br/>
            <input style="width: 250px" type="text" id="name"/>
        </div>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label for="surname">Enter surname</label><br/>
            <input style="width: 250px" type="text" id="surname"/>
        </div>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label for="email">Enter email</label><br/>
            <input  style="width: 250px" type="text" id="email"/>
        </div>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label  for="age">Enter age</label><br/>
            <input style="width: 250px" type="number" id="age"/>
        </div>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label for="password">Enter password</label><br/>
            <input style="width: 250px" type="text" id="password"/>
        </div>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <label for ="role">Chose role</label><br/>
            <select id="role"  style="width: 250px; height: 60px" class="form-control" multiple>
                <option>ROLE_ADMIN</option>
                <option>ROLE_USER</option>
            </select>
        </div>
        <br/>
        <div class="form-group" style="padding-left: 300px; margin-bottom: 0">
            <input type="submit" style="background-color: green; width: 250px" class="btn btn-primary" id="addUserButton"  value="Add new User"/>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>
    function updateAndShow(){
        fetch("http://localhost:8080/rest/users").then(
            response =>{response.json().then(
                    data=>{
                        $("#userTable").empty();
                        data.forEach(u=>{
                            let template = "";
                            template += "<tr>";
                            template += "<td>" + u.id + "</td>";
                            template += "<td>" + u.name + "</td>";
                            template += "<td>" + u.surname + "</td>";
                            template += "<td>" + u.age + "</td>";
                            template += "<td>" + u.email + "</td>";
                            template += "<td>" + u.authorities[0].authority + "</td>"
                            template += "<td><!-- Button trigger modal -->" +
                                "            <button type=\"button\" class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#edit" + u.id + "\">EDIT</button>" +
                                "            <div class=\"modal fade\" id=\"edit" + u.id + "\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"exampleModalLabel\" aria-hidden=\"true\">" +
                                "                <div class=\"modal-dialog\">" +
                                "                    <div class=\"modal-content\">" +
                                "                        <div class=\"modal-header\">" +
                                "                            <h5 class=\"modal-title\" id=\"exampleModalLabel\">User-Edit Form</h5>" +
                                "                            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>" +
                                "                        </div>" +
                                "                        <div class=\"modal-body\">" +
                                "                            <form id=\"editForm" + u.id + "\" name=\"editUserForm" + u.id + "\">" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">ID:" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"id\" value=\""+ u.id + "\" readonly></label>" +
                                "                                </div>" +
                                "                            <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">Enter name:" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"name\" value=\""+ u.name + "\"></label>" +
                                "                                </div>" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">Enter surname:" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"surname\" value=\""+ u.surname + "\"></label>" +
                                "                                </div>" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">Enter email" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"email\" value=\""+ u.email + "\"></label>" +
                                "                                </div>" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">Enter age" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"age\" value=\""+ u.age + "\"></label>" +
                                "                                </div>" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label>Chose role<br/>" +
                                "                                    <select name=\"role\" id=\"selectRoles" + u.id + "\" style=\"width: 100%; height: 45px\" multiple class=\"col-form-control\" multiple></label>" +
                                "                                        <option >ROLE_ADMIN</option>" +
                                "                                        <option>ROLE_USER</option>" +
                                "                                    </select>" +
                                "                                </div>" +
                                "                            </form>" +
                                "                        </div>" +
                                "                        <div class=\"modal-footer\">" +
                                "                             <button type=\"submit\" id=\"editUserSubmit" + u.id + "\" form=\"editForm" + u.id + "\"  class=\"btn btn-primary\" data-bs-dismiss=\"modal\" aria-label=\"Close\">EDIT</button>" +
                                "                        </div>" +
                                "                    </div>" +
                                "                </div>" +
                                "            </div>" +
                                "        </td>";

                            template += "<td>" +
                                "             <button type=\"button\"  style=\"background-color: red\" class=\"btn btn-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#delete" + u.id + "\">DELETE</button>" +
                                "             <div class=\"modal fade\" id=\"delete" + u.id + "\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"exampleModalLabel\" aria-hidden=\"true\">" +
                                "                 <div class=\"modal-dialog\">" +
                                "                     <div class=\"modal-content\">" +
                                "                         <div class=\"modal-header\">" +
                                "                             <h5 class=\"modal-title\" id=\"ModalLabel\">New message</h5>" +
                                "                             <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>" +
                                "                         </div>" +
                                "                         <div class=\"modal-body\">" +
                                "                             <form >" +
                                "                                <div class=\"form-group text-center\">" +
                                "                                    <label class=\"col-form-label\">ID:" +
                                "                                    <input type=\"text\" class=\"form-control\" name=\"id\" value=\""+ u.id + "\" readonly></label>" +
                                "                                </div>" +
                                "                             <div class=\"form-group text-center\">" +
                                "                                     <label class=\"col-form-label\">Name:" +
                                "                                     <input type=\"text\" class=\"form-control\" id=\"user-name" + u.id + "\" value=\""+ u.name + "\" readonly></label>" +
                                "                                 </div>" +
                                "                                 <div class=\"form-group text-center\">" +
                                "                                     <label class=\"col-form-label\">Surname:" +
                                "                                     <input type=\"text\" class=\"form-control\" value=\""+ u.surname + "\" readonly></label>" +
                                "                                 </div>" +
                                "                                 <div class=\"form-group text-center\">" +
                                "                                     <label for=\"user-email-delete\" class=\"col-form-label\">Email:" +
                                "                                     <input type=\"text\" class=\"form-control\" value=\""+ u.email + "\" readonly></label>" +
                                "                                 </div>" +
                                "                                 <div class=\"form-group text-center\">" +
                                "                                     <label class=\"col-form-label\">Age:" +
                                "                                     <input type=\"text\" class=\"form-control\" value=\""+ u.age + "\" readonly></label>" +
                                "                                 </div>" +
                                "                                 <div class=\"form-group text-center\">" +
                                "                                     <label class=\"col-form-label\">Role:" +
                                "                                     <input type=\"text\" class=\"form-control\" value=\""+ u.authorities[0].authority + "\" readonly></label>" +
                                "                                 </div>" +
                                "                             </form>" +
                                "                         </div>" +
                                "                         <div class=\"modal-footer\">" +
                                "                             <button type=\"button\" id=\"deleteSubmit" + u.id + "\"  class=\"btn btn-primary\" data-bs-dismiss=\"modal\" value='DELETE' aria-label=\"Close\">DELETE</button>" +
                                "                         </div>" +
                                "                     </div>" +
                                "                 </div>" +
                                "             </div>" +
                                "" +
                                "         </td>"
                            template += "</tr>";



                            $("#userTable").prepend(template);
                            $("#deleteSubmit" + u.id).click(function (){
                                deleteUser(u.id);
                            });


                            $("#editUserSubmit" + u.id).click(function (event){
                                event.preventDefault()
                                let id = 0;
                                let user;
                                if (document.getElementById("editForm" + u.id).elements["role"].value == "ROLE_ADMIN") {id = 1}
                                if (document.getElementById("editForm" + u.id).elements["role"].value == "ROLE_USER") {id = 2}
                                if($("#selectRoles" + u.id).val().length == 2){
                                    user = {
                                        "name":document.getElementById("editForm" + u.id).elements["name"].value,
                                        "surname":document.getElementById("editForm" + u.id).elements["surname"].value,
                                        "age":document.getElementById("editForm" + u.id).elements["age"].value,
                                        "email":document.getElementById("editForm" + u.id).elements["email"].value,
                                        "roles":[{"id":1,
                                            "role":"ROLE_ADMIN",
                                            "authority":"ROLE_ADMIN"},
                                            {"id":2,
                                                "role":"ROLE_USER",
                                                "authority":"ROLE_USER"}]
                                }} else{
                                    if (id!=0){
                                        user = {
                                    "name":document.getElementById("editForm" + u.id).elements["name"].value,
                                    "surname":document.getElementById("editForm" + u.id).elements["surname"].value,
                                    "age":document.getElementById("editForm" + u.id).elements["age"].value,
                                    "email":document.getElementById("editForm" + u.id).elements["email"].value,
                                    "roles":[{"id":id,
                                        "role":document.getElementById("editForm" + u.id).elements["role"].value,
                                        "authority":document.getElementById("editForm" + u.id).elements["role"].value}]
                                };}else{
                                    user = {"name":document.getElementById("editForm" + u.id).elements["name"].value,
                                        "surname":document.getElementById("editForm" + u.id).elements["surname"].value,
                                        "age":document.getElementById("editForm" + u.id).elements["age"].value,
                                        "email":document.getElementById("editForm" + u.id).elements["email"].value}
                                }}
                                updateUser(user, u.id)
                            })
                        })
                    }
                )
            }
        )

    };

    $(document).ready(function() {

        updateAndShow();

    });


    $("#toUser").click(function (){
        console.log(document.getElementById("editForm" + 24).elements["email"].value);
        $("#tableContainer").hide();
        $("#newUserContainer").show()
    })

    $("#toTable").click(function (){
        $("#tableContainer").show();
        $("#newUserContainer").hide();
    })

    function deleteUser(userId){
        $.ajax({
            type: 'DELETE',
            url: 'rest/delete/' + userId,
            timeout: 3000,
            success: function (){
                updateAndShow()
            }
        })
        }

    $("#addUserButton").click(function (event){
        event.preventDefault()
        let form = document.addUserForm
        let id
        let user
        if (form.elements["role"].value == "ROLE_ADMIN") {id = 1}
        if (form.elements["role"].value == "ROLE_USER") {id = 2}
        if ($("#role").val().length == 2){
            user = {
                "name":form.elements["name"].value,
                "surname":form.elements["surname"].value,
                "age":form.elements["age"].value,
                "email":form.elements["email"].value,
                "password":form.elements["password"].value,
                "roles":[{"id":1,
                    "role":"ROLE_ADMIN",
                    "authority":"ROLE_ADMIN"},
                    {"id":2,
                        "role":"ROLE_USER",
                        "authority":"ROLE_USER"}]}
        } else{
             user = {
            "name":form.elements["name"].value,
            "surname":form.elements["surname"].value,
            "age":form.elements["age"].value,
            "email":form.elements["email"].value,
            "password":form.elements["password"].value,
            "roles":[{"id":id,
                "role":form.elements["role"].value,
                "authority":form.elements["role"].value}]
        };}
        addUser(user);
    })

    function updateUser(user, id){
        $.ajax({
            type: "PUT",
            url: 'rest/update/' + id,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(user),
            timeout: 3000,
            success: function (){
                updateAndShow();
                $("#editForm" + id)[0].reset();
            }
        })
    }


    function addUser(user){
        $.ajax({
            type: "POST",
            url: 'rest/new',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(user),
            timeout: 3000,
            success: function (){
                updateAndShow();
                $("#newUserForm")[0].reset();
                $("#tableContainer").show();
                $("#newUserContainer").hide();
            }
        })
    }

</script>
</body>
</html>